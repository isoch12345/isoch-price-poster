name: Price upload reminder

on:
  schedule:
    - cron: "30 7 * * *"   # 07:30 UTC = 13:00 IST
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check log + remind purchase if missing
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          PURCHASE_REMIND_TO: ${{ secrets.PURCHASE_REMIND_TO }}
        run: |
          python - <<'PY'
          import os, json, datetime, smtplib
          from email.mime.text import MIMEText

          log_path = "logs/price_sent_log.jsonl"
          today = datetime.date.today().isoformat()

          sent = False
          if os.path.exists(log_path):
            with open(log_path, "r", encoding="utf-8") as f:
              for line in f:
                line=line.strip()
                if not line:
                  continue
                try:
                  obj=json.loads(line)
                  if obj.get("date")==today:
                    sent=True
                    break
                except:
                  pass

          if sent:
            print("Already sent today:", today)
            raise SystemExit(0)

          to_list = [x.strip() for x in os.environ.get("PURCHASE_REMIND_TO","").split(",") if x.strip()]
          if not to_list:
            to_list = ["purchase@innovativesoch.com"]

          subj = f"Reminder: Price update NOT sent yet ({today})"
          body = (
            "Hi Team,\n\n"
            "This is a reminder that today's price update has not been sent yet.\n"
            "Please upload Excel in the ISOCH Price Poster app and click Generate & Send.\n\n"
            "Regards,\nISOCH System\n"
          )

          msg = MIMEText(body)
          msg["Subject"] = subj
          msg["From"] = os.environ["SMTP_USER"]
          msg["To"] = ", ".join(to_list)

          host=os.environ["SMTP_HOST"]
          port=int(os.environ["SMTP_PORT"])

          with smtplib.SMTP_SSL(host, port) as s:
            s.login(os.environ["SMTP_USER"], os.environ["SMTP_PASS"])
            s.sendmail(os.environ["SMTP_USER"], to_list, msg.as_string())

          print("Reminder sent to:", to_list)
          PY
